<!DOCTYPE html>
<html>
<head>
  <title>Chat Interface</title>
</head>
<body>
  <h2>Welcome {{ user_id }}</h2>

  <div>
    <input type="text" id="targetUserId" placeholder="Enter 10-digit user ID to chat">
    <button onclick="startChat()">Start Chat</button>
    <p id="statusMessage" style="color: green;"></p>
  </div>

  <hr>

  <div id="chat-box" style="border: 1px solid black; height: 300px; overflow-y: scroll; padding: 10px;"></div>
  <input type="text" id="messageInput" placeholder="Type your message">
  <button onclick="sendMessage()">Send</button>

  <script>
    const currentUserId = "{{ user_id }}";
    let targetUserId = null;
    let ws = null;

    function logToChatBox(message) {
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<p>${message}</p>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function startChat() {
      targetUserId = document.getElementById("targetUserId").value.trim();
      const statusMessage = document.getElementById("statusMessage");

      if (targetUserId.length !== 10 || isNaN(targetUserId)) {
        statusMessage.innerText = "‚ùå Invalid User ID. Must be 10 digits.";
        statusMessage.style.color = "red";
        return;
      }

      fetch(`/check-user/${targetUserId}`)
        .then(response => {
          if (!response.ok) throw new Error("User not online");
          return response.json();
        })
        .then(data => {
          statusMessage.innerText = `‚úÖ Chat started with ${targetUserId}`;
          statusMessage.style.color = "green";
          setupWebSocket();
        })
        .catch(() => {
          statusMessage.innerText = "‚ùå User is not online.";
          statusMessage.style.color = "red";
        });
    }

    function setupWebSocket() {
      if (ws) {
        ws.close();
      }

      ws = new WebSocket(`ws://localhost:8000/ws/${currentUserId}`);
      console.log(ws)
      ws.onopen = () => {
        console.log("WebSocket connected");
        logToChatBox(`üü¢ Connected as ${currentUserId}`);
      };

      ws.onmessage = function(event) {
        logToChatBox(`üì® ${event.data}`);
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
        logToChatBox("üî¥ WebSocket connection closed.");
      };

      ws.onerror = (e) => {
        console.error("WebSocket error:", e);
        logToChatBox("‚ö†Ô∏è WebSocket error occurred.");
      };
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (!message) return;

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(message);
        logToChatBox(`üßë‚Äçüí¨ You: ${message}`);
        input.value = "";
      } else {
        logToChatBox("‚ö†Ô∏è Cannot send, WebSocket not connected.");
      }
    }
  </script>
</body>
</html>


